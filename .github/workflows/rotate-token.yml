name: ðŸ” Rotate NPM Token

on:
  schedule:
    - cron: "0 3 */90 * *" # Runs every 90 days at 03:00 UTC
  workflow_dispatch:

jobs:
  rotate-npm-token:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§¾ Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: ðŸ” Login no npm com master token
        env:
          NPM_MASTER_TOKEN: ${{ secrets.NPM_MASTER_TOKEN }}
        run: |
          echo "//registry.npmjs.org/:_authToken=${NPM_MASTER_TOKEN}" > ~/.npmrc

      - name: ðŸŒ€ Generate new granular token (expires in 90 days)
        id: new-token
        run: |
          # Generates granular automation token with 90-day expiration
          TOKEN_JSON=$(npm token create --read-only --ttl=90d --json)
          TOKEN=$(echo "$TOKEN_JSON" | jq -r '.token')
          echo "token=$TOKEN" >> $GITHUB_OUTPUT
          echo "âœ… New token generated with a 90-day expiration."

      - name: ðŸ”„ Update secret NPM_TOKEN in the repository
        run: gh secret set NPM_TOKEN --body "${{ steps.new-token.outputs.token }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ§¹ Revoke old tokens
        run: npm token list --json | jq -r '.[].token' | grep -v "${{ steps.new-token.outputs.token }}" | xargs -I {} npm token revoke {}
        env:
          NPM_MASTER_TOKEN: ${{ secrets.NPM_MASTER_TOKEN }}
